<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>留言板</title>
	<style type="text/css">
		body,p,ul,li{margin:0;padding:0;}
		li{list-style:none;}
		.box{width:500px;height:450px;border:1px solid greenyellow;margin:0 auto;}
		.notes{width:500px;height:400px;background: violet;margin:0 auto;overflow-y: scroll;}
		p{text-align:center;background: #666;line-height: 40px;height: 40px;color:greenyellow;font-weight: bloder;font-size:20px;letter-spacing:4px;}
		li{width:40%;background:#eee;color:orange;font-weight: bloder;font-size:20px;letter-spacing:4px;border-radius:20px;margin: 4px;padding-left:20px;}
		button:nth-child(2){margin-left:120px;}
		button{padding:5px 10px;margin:10px 0 10px 40px;}
		.note{position:fixed;background: rgba(0,0,0,.4);width:100%;height:100%;left:0;top:0;display: none;}
		form{position: absolute;left: 0;right:0;margin:0 auto;top:70px;width:300px;height:260px;}
		textarea{width:300px;height:260px;resize: none;}
		form button:nth-child(2){margin-left:80px;}
		form button{padding:5px 10px;margin:10px auto;}

		.changebg{background:greenyellow;}
	</style>
</head>
<body>
	<div class="box">
		<div class="notes">
			<p>留言板</p>
			<ul></ul>
		</div>
		<button>添加留言</button>
		<button>删除留言</button>
	</div>
	<div class="note">
		<form>
			<textarea>留言：</textarea>
			<button>提交留言</button>
			<button>关闭窗口</button>
		</form>
	</div>
</body>
<script type="text/javascript">

	var oul = document.getElementsByClassName("notes")[0].children[1];
	var oli = document.getElementsByClassName("notes")[0].children[1].children;
	var obtn1 = document.getElementsByTagName("button")[0];
	var onote = document.getElementsByClassName("note")[0];
	var obtn2 = document.getElementsByTagName("button")[2];
	var obtn3 = document.getElementsByTagName("button")[1];
	var obtn4 = document.getElementsByTagName("button")[3];
	var oval = document.getElementsByTagName("textarea")[0];
	var odel = document.getElementsByClassName("changebg");


	window.onload = function(){//在页面加载完成后获取留言板的内容，然后延时获取页面中的li标签，当被点击时添加或删除样式.
		GET(function (){
			for(var j=0;j<oli.length;j++){
				oli[j].index = j;
				oli[j].onclick = function(){
					if(oli[this.index].className == "changebg"){
						oli[this.index].className = "";
					}else{
						oli[this.index].className = "changebg";
					};
				};
			};
		});
	};


	obtn1.onclick = function(){//点击添加留言时，显示并重置文本域的内容;
		onote.style.display = "block";
		oval.value = "留言:";

	};
	obtn2.onclick = function(){//点击提交留言到数据库，成功则创建这条留言;点击提交数据就将文本域隐藏;
		if(oval.value == "留言:"){
			alert("请输入留言信息");
			return false;
		};
		var ogetval =  oval.value;
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function (){
			if(xhr.readyState == 4&&(xhr.status >= 200&&xhr.status < 300||xhr.status == 304)){
				// var text = xhr.responseText;
				// var otext = text.split("!@#$");
				// // console.log(otext);
				// otext.pop();
				// for(var i=0;i < otext.length;i++){
				// 	create(otext[i]);
				// };
				create(oval.value);
				for(var j=0;j<oli.length;j++){//点击留言(li)时，存在则添加样式，否则就删删除样式。
					oli[j].index = j;
					oli[j].onclick = function(){
						if(oli[this.index].className == "changebg"){
							oli[this.index].className = "";
						}else{
							oli[this.index].className = "changebg";
						};
					};
				};
			}
		};
		xhr.open("GET","val.php?val="+ogetval,true);
		xhr.send(null);
		onote.style.display = "none";
		
		return false;
	};

	obtn3.onclick = function(){//点击删除按钮的时候，先删除本地的li，然后将需要删除的值提交到数据库
		for(var i=0;i<odel.length;){
			var otext = odel[i].innerHTML;
			oul.removeChild(odel[i]);
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4&&(xhr.status >= 200&&xhr.status < 300||xhr.status == 304)){
					// console.log("aa");
				};
			};
			xhr.open("GET","update.php?val="+otext,true);
			xhr.send(null);
		};
		compose();
	};



	obtn4.onclick = function(){
		onote.style.display = "none";
	};


	function GET(fn){//利用ajax获取到内容  并将他封装起来
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function (){
			if(xhr.readyState == 4&&(xhr.status >= 200&&xhr.status < 300||xhr.status == 304)){
				var text = xhr.responseText;
				var otext = text.split("!@#$");
				otext.pop();
				// console.log(otext)
				for(var i=0;i < otext.length;i++){//将获取到的留言遍历出来，并创建
					create(otext[i]);
				};
				fn();
			};
		};
		xhr.open("GET","val.php",true);
		xhr.send(null);
	};

	function create(val){//这个是创建li标签,如果需要更改的值则获取更改的值，没有值则就获取文本域里面的内容，在添加到ul中
		if(!val)val = oval.value;
		var cli = document.createElement("li");
		cli.innerHTML = val;
		oul.appendChild(cli);
		compose();
	};



	function compose(){ //这个是将li进行排版(左右对话式),获取长度然后利用奇偶来进行排序
		var olil = oli.length;
		for(var i=0;i<olil;i++){
			if(i%2==0){
				oli[i].style.float = "left";
				oli[i].style.clear = "both";
			}else{
				oli[i].style.float = "right";
				oli[i].style.clear = "both";
			};
		};
	};
</script>
</html>